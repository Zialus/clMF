environment:
  BLOCKS_FLAG: '2'
  THREADS_FLAG: '2'
  matrix:
  - WHATOPENCL: NVIDIA
    APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1804
  - WHATOPENCL: POCL
    APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1804
  - WHATOPENCL: AMD
    APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1604
  - WHATOPENCL: INTEL
    APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1804
  - WHATOPENCL: INTEL
    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017

before_build:
  - ps: appveyor DownloadFile "http://registrationcenter-download.intel.com/akdlm/irc_nas/vcp/12527/intel_sdk_for_opencl_2017_7.0.0.2567.exe"
  - ps: appveyor DownloadFile "http://registrationcenter-download.intel.com/akdlm/irc_nas/12512/opencl_runtime_16.1.2_x64_setup.msi"
  - ps: appveyor DownloadFile "https://ci.appveyor.com/api/projects/oblomov/clinfo/artifacts/clinfo.exe?job=platform:+x64" -FileName clinfo.exe
  - start /wait msiexec /i opencl_runtime_16.1.2_x64_setup.msi /qn
  - start /wait .\intel_sdk_for_opencl_2017_7.0.0.2567.exe install --output=output.log --eula=accept
  - type output.log
  - set INTELOCLSDKROOT=C:\Intel\OpenCL\sdk
  - dir %INTELOCLSDKROOT%

build_script:
  - cmake --version
  - .\clinfo.exe
  - mkdir build && cd build
  - cmake -G "Visual Studio 15 2017 Win64" ..
  - cmake --build . --config Release

test_script:
  - echo "Windows is segfaulting"

artifacts:
  - path: exec

for:
-
  matrix:
    only:
    - WHATOPENCL: INTEL
      APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1804

  init:
    - uname -a
  before_build:
    - sudo apt-get install clinfo opencl-headers -y
    - source scripts/opencl_install.sh
    - echo $AMDAPPSDKROOT
    - echo $BLOCKS_FLAG
    - echo $THREADS_FLAG

  build_script:
    - cmake --version
    - clinfo
    - mkdir build && cd build
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - make

  test_script:
    - ctest -V -C Release

-
  matrix:
    only:
    - WHATOPENCL: AMD
      APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1604

  init:
    - uname -a
  before_build:
    - sudo apt-get install clinfo opencl-headers -y
    - source scripts/amdappsdk_install.sh
    - echo $AMDAPPSDKROOT
    - echo $BLOCKS_FLAG
    - echo $THREADS_FLAG

  build_script:
    - cmake --version
    - clinfo
    - mkdir build && cd build
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - make

  test_script:
    - ctest -V -C Release

-
  matrix:
    only:
    - WHATOPENCL: POCL
      APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1804

  init:
    - uname -a
  before_build:
    - sudo apt-get install libpocl-dev -y
    - sudo apt-get install opencl-headers clinfo -y
    - echo $AMDAPPSDKROOT
    - echo $BLOCKS_FLAG
    - echo $THREADS_FLAG

  build_script:
    - cmake --version
    - poclcc -l
    - clinfo
    - mkdir build && cd build
    - cmake -DCMAKE_BUILD_TYPE=Release .. -DOpenCL_LIBRARY=/usr/lib/x86_64-linux-gnu/libOpenCL.so.1
    - make

  test_script:
    - echo "POCL SEGFAULTS"

-
  matrix:
    only:
    - WHATOPENCL: NVIDIA
      APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1804

  init:
    - uname -a
  before_build:
    - wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-repo-ubuntu1804_10.0.130-1_amd64.deb
    - sudo dpkg -i cuda-repo-ubuntu1804_10.0.130-1_amd64.deb
    - sudo apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pub
    - sudo apt-get remove openjdk-11-jre-headless -y --allow-change-held-packages
    - sudo apt-get update
    - sudo apt-get install cuda -y -o Dpkg::Options::="--force-confnew"
    - sudo apt-get clean
    - sudo apt-get install clinfo -y
    - export CUDA_PATH=/usr/local/cuda
    - echo $CUDA_PATH
    - echo $BLOCKS_FLAG
    - echo $THREADS_FLAG

  build_script:
    - cmake --version
    - clinfo
    - mkdir build && cd build
    - cmake -DCMAKE_BUILD_TYPE=Release ..
    - make

  test_script:
    - echo "Appveyor machine doesn't have NVIDIA GPU"
